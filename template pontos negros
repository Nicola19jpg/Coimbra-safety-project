!pip install folium geopandas scikit-learn hdbscan --quiet

# PONTOS NEGROS {year} 

import pandas as pd
import geopandas as gpd
from shapely.geometry import Point
import folium
from folium.plugins import Geocoder
from sklearn.cluster import DBSCAN
import numpy as np
import matplotlib.cm as cm
import matplotlib.colors as colors

## Data Loading and Preparation
df = pd.read_csv(CSV_PATH, quotechar='"')

geometry = [Point(xy) for xy in zip(df['Longitude GPS'], df['Latitude GPS'])]
gdf = gpd.GeoDataFrame(df, geometry=geometry, crs="EPSG:4326")
gdf_meters = gdf.to_crs(epsg=3763)
coords = np.array(list(zip(gdf_meters.geometry.x, gdf_meters.geometry.y)))

## DBSCAN Clustering
db = DBSCAN(eps=200, min_samples=5, metric='euclidean').fit(coords)
gdf["Cluster"] = db.labels_.astype(str)

tabella_cluster = gdf[gdf["Cluster"] != "-1"].groupby("Cluster").agg(
    Conteggio_Incidenti=('Ind. Gravidade', 'count'),
    Gravidade_Cumulata=('Ind. Gravidade', 'sum')
).reset_index()

## Cluster Aggregation and Severity Filtering
tabella_cluster = gdf[gdf["Cluster"] != "-1"].groupby("Cluster").agg(
    Conteggio_Incidenti=('Ind. Gravidade', 'count'),
    Gravidade_Cumulata=('Ind. Gravidade', 'sum')
).reset_index()

hotspots_validi = tabella_cluster[tabella_cluster["Gravidade_Cumulata"] > 20].copy()
hotspots_validi = hotspots_validi.sort_values(by="Gravidade_Cumulata", ascending=False)
hotspots_validi.columns = ["ID Cluster", "Conteggio Incidenti", "Indice Gravidade Cumulato"]

lista_id_validi = hotspots_validi["ID Cluster"].tolist()
gdf_mappa = gdf[gdf["Cluster"].isin(lista_id_validi)].copy()
 
print("=== PONTOS NEGROS {year} ===")

if hotspots_validi.empty:
    print("Nessun cluster soddisfa i criteri.")
else:
    display(hotspots_validi)

    ## Interactive Map Setup
    coimbra_coords = [gdf_mappa['Latitude GPS'].mean(), gdf_mappa['Longitude GPS'].mean()]
    map_coimbra = folium.Map(location=coimbra_coords, zoom_start=14, tiles="CartoDB Positron")
    Geocoder(collapsed=False, position='topright', add_marker=True).add_to(map_coimbra)

    unique_clusters = sorted(gdf_mappa["Cluster"].unique())
    cmap = cm.get_cmap('tab20', len(unique_clusters))
    cluster_colors = {cluster: colors.rgb2hex(cmap(i)) for i, cluster in enumerate(unique_clusters)}

    ## Add Buffers
    cluster_centers = gdf_mappa.groupby("Cluster").agg({'Latitude GPS': 'mean', 'Longitude GPS': 'mean'}).reset_index()
    for _, center in cluster_centers.iterrows():
        folium.Circle(
            location=[center["Latitude GPS"], center["Longitude GPS"]],
            radius=200,
            color=cluster_colors[center["Cluster"]],
            fill=True, fill_opacity=0.1, weight=1, dash_array='5, 5'
        ).add_to(map_coimbra)

    ## Add Points
    for _, row in gdf_mappa.iterrows():
        folium.CircleMarker(
            location=[row["Latitude GPS"], row["Longitude GPS"]],
            radius=6,
            color=cluster_colors[row["Cluster"]],
            fill=True, fill_opacity=0.8,
            popup=f"<b>Cluster</b>: {row['Cluster']}<br>"
            f"<b>Gravit√†</b>: {row['Ind. Gravidade']}<br>"
            f"<b>Lat</b>: {row['Latitude GPS']}<br>"
            f"<b>Long</b>: {row['Longitude GPS']}"
        ).add_to(map_coimbra)

## Results Display
    display(map_coimbra)




